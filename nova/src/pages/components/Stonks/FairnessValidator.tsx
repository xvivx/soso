import { useEffect, useMemo, useState } from 'react';
import { getI18n, useTranslation } from 'react-i18next';
import { Button, FormItem, Input, Modal } from '@components';
import { request } from '@utils/axios';

function FairnessValidator() {
  const [form, setForm] = useState({
    seed: '',
    startTime: '00:00:00',
    endTime: '00:00:15',
  });
  const [validateRes, setValidateRes] = useState<boolean[]>([]);
  const [klineData, setKlineData] = useState<{ index: number; price: string }[]>([]);
  const { t } = useTranslation();

  const code = useMemo(() => {
    return klineData.map((kline) => {
      return `Price at time ${kline.index}: ${kline.price}\r\n`;
    });
  }, [klineData]);

  const onVerify = async () => {
    const validate = [
      !!form.seed,
      !!isValidTimeFormat(form.startTime),
      !!isValidTimeFormat(form.endTime),
      !(!!form.startTime && !!form.endTime && form.startTime > form.endTime),
    ];
    setValidateRes(validate);
    if (validate.findIndex((it) => it === false) > -1) {
      return;
    }

    const res = await request.get<{ index: number; price: string }[]>(`/api/coin/detrade/stonks/seed/prices`, form);
    setKlineData(res.slice(0, 100));
  };

  useEffect(() => {
    setValidateRes([]);
  }, [form]);

  return (
    <div className="space-y-4">
      <FormItem label={t('Seed')} error={validateRes[0] === false && t('Please enter the seed')}>
        <Input size="lg" value={form.seed} onChange={(value) => setForm({ ...form, seed: value })} />
      </FormItem>
      <FormItem label={t('Start Time')} error={validateRes[1] === false && t('Start Time Invalid( hh : mm : ss )')}>
        <Input size="lg" value={form.startTime} onChange={(value) => setForm({ ...form, startTime: value })} />
      </FormItem>
      <FormItem
        label={t('End Time')}
        error={
          (validateRes[2] === false || validateRes[3] === false) && (
            <>
              {validateRes[2] === false && t('End Time Invalid( hh : mm : ss )')}
              <br />
              {validateRes[3] === false && t('End Time is earlier than Start Time')}
            </>
          )
        }
      >
        <Input size="lg" value={form.endTime} onChange={(value) => setForm({ ...form, endTime: value })} />
      </FormItem>
      <Button onClick={onVerify} className="flex-1 w-full" size="lg">
        {t('Verify')}
      </Button>
      <div>
        <p className="my-2 leading-6 text-14 text-secondary">{t('The output is:')}</p>
        <pre className="p-3 overflow-x-auto min-h-20 rounded-2 text-12 bg-layer1 text-secondary">{code}</pre>
      </div>
    </div>
  );
}

export default FairnessValidator;

function isValidTimeFormat(timeString: string) {
  const timeRegex = /^([01][0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/;
  return timeRegex.test(timeString);
}

export function showStonksFairnes() {
  Modal.open({
    title: getI18n().t('Verify Fairness'),
    children: <FairnessValidator />,
  });
}

export function FairnesHelp() {
  const { t } = useTranslation();
  return (
    <div className="flex items-center gap-3 text-tertiary">
      <svg width="102" height="27" viewBox="0 0 102 27" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="0.25" y="0.25" width="101.5" height="26.5" rx="7.75" stroke="currentColor" strokeWidth="0.5" />
        <g clipPath="url(#clip0_16995_318324)">
          <path
            d="M16.9988 4.5L9.79883 7.2V12.015C9.79974 13.8458 10.2661 15.6464 11.154 17.2475C12.0419 18.8486 13.3223 20.1977 14.8748 21.168L16.9988 22.5L19.1228 21.168C20.6754 20.1977 21.9557 18.8486 22.8437 17.2475C23.7316 15.6464 24.1979 13.8458 24.1988 12.015V7.2L16.9988 4.5ZM15.7298 16.101L14.4518 14.823L12.5438 12.915L13.8128 11.646L15.7208 13.554L20.1758 9.099L21.4448 10.368L15.7298 16.101Z"
            fill="currentColor"
          />
        </g>
        <line x1="34.25" y1="4.55664" x2="34.25" y2="22.4426" stroke="currentColor" strokeWidth="0.5" />
        <path
          d="M46.352 6.416V7.32H44.864V12H43.744V7.32H42.256V6.416H46.352ZM51.8012 6.416V12H50.6812V9.624H48.2892V12H47.1692V6.416H48.2892V8.712H50.6812V6.416H51.8012ZM54.0236 6.416V12H52.9036V6.416H54.0236ZM57.0581 12.056C56.6688 12.056 56.3168 11.9893 56.0021 11.856C55.6928 11.7227 55.4475 11.5307 55.2661 11.28C55.0848 11.0293 54.9915 10.7333 54.9861 10.392H56.1861C56.2021 10.6213 56.2821 10.8027 56.4261 10.936C56.5755 11.0693 56.7781 11.136 57.0341 11.136C57.2955 11.136 57.5008 11.0747 57.6501 10.952C57.7995 10.824 57.8741 10.6587 57.8741 10.456C57.8741 10.2907 57.8235 10.1547 57.7221 10.048C57.6208 9.94133 57.4928 9.85867 57.3381 9.8C57.1888 9.736 56.9808 9.66667 56.7141 9.592C56.3515 9.48533 56.0555 9.38133 55.8261 9.28C55.6021 9.17333 55.4075 9.016 55.2421 8.808C55.0821 8.59467 55.0021 8.312 55.0021 7.96C55.0021 7.62933 55.0848 7.34133 55.2501 7.096C55.4155 6.85067 55.6475 6.664 55.9461 6.536C56.2448 6.40267 56.5861 6.336 56.9701 6.336C57.5461 6.336 58.0128 6.47733 58.3701 6.76C58.7328 7.03733 58.9328 7.42667 58.9701 7.928H57.7381C57.7275 7.736 57.6448 7.57867 57.4901 7.456C57.3408 7.328 57.1408 7.264 56.8901 7.264C56.6715 7.264 56.4955 7.32 56.3621 7.432C56.2341 7.544 56.1701 7.70667 56.1701 7.92C56.1701 8.06933 56.2181 8.19467 56.3141 8.296C56.4155 8.392 56.5381 8.472 56.6821 8.536C56.8315 8.59467 57.0395 8.664 57.3061 8.744C57.6688 8.85067 57.9648 8.95733 58.1941 9.064C58.4235 9.17067 58.6208 9.33067 58.7861 9.544C58.9515 9.75733 59.0341 10.0373 59.0341 10.384C59.0341 10.6827 58.9568 10.96 58.8021 11.216C58.6475 11.472 58.4208 11.6773 58.1221 11.832C57.8235 11.9813 57.4688 12.056 57.0581 12.056ZM65.7994 8.096C65.6714 7.86133 65.4954 7.68267 65.2714 7.56C65.0474 7.43733 64.786 7.376 64.4874 7.376C64.1567 7.376 63.8634 7.45067 63.6074 7.6C63.3514 7.74933 63.1514 7.96267 63.0074 8.24C62.8634 8.51733 62.7914 8.83733 62.7914 9.2C62.7914 9.57333 62.8634 9.89867 63.0074 10.176C63.1567 10.4533 63.362 10.6667 63.6234 10.816C63.8847 10.9653 64.1887 11.04 64.5354 11.04C64.962 11.04 65.3114 10.928 65.5834 10.704C65.8554 10.4747 66.034 10.1573 66.1194 9.752H64.1994V8.896H67.2234V9.872C67.1487 10.2613 66.9887 10.6213 66.7434 10.952C66.498 11.2827 66.1807 11.5493 65.7914 11.752C65.4074 11.9493 64.9754 12.048 64.4954 12.048C63.9567 12.048 63.4687 11.928 63.0314 11.688C62.5994 11.4427 62.258 11.104 62.0074 10.672C61.762 10.24 61.6394 9.74933 61.6394 9.2C61.6394 8.65067 61.762 8.16 62.0074 7.728C62.258 7.29067 62.5994 6.952 63.0314 6.712C63.4687 6.46667 63.954 6.344 64.4874 6.344C65.1167 6.344 65.6634 6.49867 66.1274 6.808C66.5914 7.112 66.9114 7.54133 67.0874 8.096H65.7994ZM71.476 10.936H69.252L68.884 12H67.708L69.716 6.408H71.02L73.028 12H71.844L71.476 10.936ZM71.172 10.04L70.364 7.704L69.556 10.04H71.172ZM79.8666 6.416V12H78.7466V8.368L77.2506 12H76.4026L74.8986 8.368V12H73.7786V6.416H75.0506L76.8266 10.568L78.6026 6.416H79.8666ZM82.0939 7.32V8.72H83.9739V9.608H82.0939V11.088H84.2139V12H80.9739V6.408H84.2139V7.32H82.0939ZM88.2579 6.416V12H87.1379V6.416H88.2579ZM91.2925 12.056C90.9032 12.056 90.5512 11.9893 90.2365 11.856C89.9272 11.7227 89.6818 11.5307 89.5005 11.28C89.3192 11.0293 89.2258 10.7333 89.2205 10.392H90.4205C90.4365 10.6213 90.5165 10.8027 90.6605 10.936C90.8098 11.0693 91.0125 11.136 91.2685 11.136C91.5298 11.136 91.7352 11.0747 91.8845 10.952C92.0338 10.824 92.1085 10.6587 92.1085 10.456C92.1085 10.2907 92.0578 10.1547 91.9565 10.048C91.8552 9.94133 91.7272 9.85867 91.5725 9.8C91.4232 9.736 91.2152 9.66667 90.9485 9.592C90.5858 9.48533 90.2898 9.38133 90.0605 9.28C89.8365 9.17333 89.6418 9.016 89.4765 8.808C89.3165 8.59467 89.2365 8.312 89.2365 7.96C89.2365 7.62933 89.3192 7.34133 89.4845 7.096C89.6498 6.85067 89.8818 6.664 90.1805 6.536C90.4792 6.40267 90.8205 6.336 91.2045 6.336C91.7805 6.336 92.2472 6.47733 92.6045 6.76C92.9672 7.03733 93.1672 7.42667 93.2045 7.928H91.9725C91.9618 7.736 91.8792 7.57867 91.7245 7.456C91.5752 7.328 91.3752 7.264 91.1245 7.264C90.9058 7.264 90.7298 7.32 90.5965 7.432C90.4685 7.544 90.4045 7.70667 90.4045 7.92C90.4045 8.06933 90.4525 8.19467 90.5485 8.296C90.6498 8.392 90.7725 8.472 90.9165 8.536C91.0658 8.59467 91.2738 8.664 91.5405 8.744C91.9032 8.85067 92.1992 8.95733 92.4285 9.064C92.6578 9.17067 92.8552 9.33067 93.0205 9.544C93.1858 9.75733 93.2685 10.0373 93.2685 10.384C93.2685 10.6827 93.1912 10.96 93.0365 11.216C92.8818 11.472 92.6552 11.6773 92.3565 11.832C92.0578 11.9813 91.7032 12.056 91.2925 12.056Z"
          fill="currentColor"
        />
        <path
          d="M45.9519 17.7045C45.9519 17.9597 45.8904 18.199 45.7673 18.4224C45.6488 18.6457 45.4596 18.8258 45.1998 18.9625C44.9445 19.0993 44.6209 19.1676 44.2289 19.1676H43.429V21H42.4718V16.2276H44.2289C44.5981 16.2276 44.9126 16.2915 45.1725 16.4191C45.4323 16.5467 45.626 16.7222 45.7536 16.9455C45.8858 17.1689 45.9519 17.4219 45.9519 17.7045ZM44.1879 18.395C44.4523 18.395 44.6483 18.3358 44.7759 18.2173C44.9035 18.0942 44.9673 17.9233 44.9673 17.7045C44.9673 17.2395 44.7075 17.0071 44.1879 17.0071H43.429V18.395H44.1879ZM49.0929 21L48.04 19.1403H47.5887V21H46.6315V16.2276H48.4228C48.7921 16.2276 49.1066 16.2937 49.3664 16.4259C49.6262 16.5535 49.8199 16.729 49.9475 16.9524C50.0797 17.1712 50.1458 17.4173 50.1458 17.6908C50.1458 18.0053 50.0547 18.2902 49.8723 18.5454C49.69 18.7961 49.4188 18.9694 49.0587 19.0651L50.2005 21H49.0929ZM47.5887 18.4224H48.3887C48.6485 18.4224 48.8422 18.3608 48.9698 18.2378C49.0974 18.1101 49.1613 17.9347 49.1613 17.7113C49.1613 17.4925 49.0974 17.3239 48.9698 17.2054C48.8422 17.0823 48.6485 17.0208 48.3887 17.0208H47.5887V18.4224ZM53.2268 21.0479C52.7801 21.0479 52.3699 20.943 51.9961 20.7333C51.6224 20.5237 51.3261 20.2342 51.1073 19.865C50.8885 19.4913 50.7791 19.0696 50.7791 18.6001C50.7791 18.1352 50.8885 17.7181 51.1073 17.3489C51.3261 16.9752 51.6224 16.6835 51.9961 16.4738C52.3699 16.2641 52.7801 16.1593 53.2268 16.1593C53.6781 16.1593 54.0883 16.2641 54.4575 16.4738C54.8313 16.6835 55.1253 16.9752 55.3395 17.3489C55.5583 17.7181 55.6677 18.1352 55.6677 18.6001C55.6677 19.0696 55.5583 19.4913 55.3395 19.865C55.1253 20.2342 54.8313 20.5237 54.4575 20.7333C54.0837 20.943 53.6735 21.0479 53.2268 21.0479ZM53.2268 20.1932C53.514 20.1932 53.767 20.1294 53.9857 20.0018C54.2045 19.8696 54.3755 19.6827 54.4985 19.4411C54.6216 19.1995 54.6831 18.9192 54.6831 18.6001C54.6831 18.2811 54.6216 18.003 54.4985 17.766C54.3755 17.5244 54.2045 17.3398 53.9857 17.2122C53.767 17.0846 53.514 17.0208 53.2268 17.0208C52.9397 17.0208 52.6844 17.0846 52.4611 17.2122C52.2423 17.3398 52.0713 17.5244 51.9483 17.766C51.8252 18.003 51.7637 18.2811 51.7637 18.6001C51.7637 18.9192 51.8252 19.1995 51.9483 19.4411C52.0713 19.6827 52.2423 19.8696 52.4611 20.0018C52.6844 20.1294 52.9397 20.1932 53.2268 20.1932ZM60.6668 16.2276L58.9164 21H57.7541L56.0038 16.2276H57.0294L58.3421 20.0223L59.648 16.2276H60.6668ZM64.167 20.0907H62.2662L61.9517 21H60.9466L62.6628 16.2208H63.7772L65.4934 21H64.4815L64.167 20.0907ZM63.9071 19.3249L63.2166 17.3284L62.526 19.3249H63.9071ZM68.8424 18.5523C69.1113 18.6024 69.3324 18.7369 69.5056 18.9557C69.6788 19.1745 69.7654 19.4252 69.7654 19.7078C69.7654 19.963 69.7016 20.1887 69.5739 20.3847C69.4509 20.5761 69.2708 20.7265 69.0338 20.8359C68.7968 20.9453 68.5165 21 68.1928 21H66.1348V16.2276H68.104C68.4276 16.2276 68.7056 16.2801 68.9381 16.3849C69.1751 16.4897 69.3529 16.6356 69.4714 16.8225C69.5945 17.0094 69.656 17.2213 69.656 17.4583C69.656 17.7364 69.5808 17.9688 69.4304 18.1557C69.2845 18.3426 69.0885 18.4748 68.8424 18.5523ZM67.0921 18.1968H67.9672C68.1951 18.1968 68.3706 18.1466 68.4937 18.0463C68.6167 17.9415 68.6783 17.7934 68.6783 17.6019C68.6783 17.4105 68.6167 17.2623 68.4937 17.1575C68.3706 17.0527 68.1951 17.0002 67.9672 17.0002H67.0921V18.1968ZM68.0561 20.2206C68.2886 20.2206 68.4686 20.1659 68.5962 20.0565C68.7284 19.9471 68.7945 19.7921 68.7945 19.5915C68.7945 19.3864 68.7261 19.2269 68.5894 19.1129C68.4527 18.9944 68.268 18.9352 68.0356 18.9352H67.0921V20.2206H68.0561ZM71.4855 20.2411H73.058V21H70.5283V16.2276H71.4855V20.2411ZM77.4611 16.2276L75.8475 19.3386V21H74.8903V19.3386L73.2699 16.2276H74.3502L75.3757 18.4087L76.3945 16.2276H77.4611ZM82.5891 16.2276V17.0002H80.5995V18.2241H82.1242V18.983H80.5995V21H79.6423V16.2276H82.5891ZM86.1942 20.0907H84.2935L83.9789 21H82.9739L84.69 16.2208H85.8045L87.5206 21H86.5087L86.1942 20.0907ZM85.9344 19.3249L85.2438 17.3284L84.5533 19.3249H85.9344ZM89.1193 16.2276V21H88.1621V16.2276H89.1193ZM92.5264 21L91.4735 19.1403H91.0222V21H90.065V16.2276H91.8563C92.2255 16.2276 92.5401 16.2937 92.7999 16.4259C93.0597 16.5535 93.2534 16.729 93.381 16.9524C93.5132 17.1712 93.5793 17.4173 93.5793 17.6908C93.5793 18.0053 93.4881 18.2902 93.3058 18.5454C93.1235 18.7961 92.8523 18.9694 92.4922 19.0651L93.634 21H92.5264ZM91.0222 18.4224H91.8222C92.082 18.4224 92.2757 18.3608 92.4033 18.2378C92.5309 18.1101 92.5948 17.9347 92.5948 17.7113C92.5948 17.4925 92.5309 17.3239 92.4033 17.2054C92.2757 17.0823 92.082 17.0208 91.8222 17.0208H91.0222V18.4224Z"
          fill="currentColor"
        />
        <defs>
          <clipPath id="clip0_16995_318324">
            <rect width="18" height="18" fill="white" transform="translate(8 4.5)" />
          </clipPath>
        </defs>
      </svg>

      <div className="text-10 leading-3 font-500" onClick={showStonksFairnes}>
        <div className="cursor-pointer underline hover:text-primary mb-0.5" style={{ fontSize: '0.9em' }}>
          {t('Verify Fairness')}
        </div>
        <div style={{ fontSize: '0.7em' }}>({t('Advanced Users')})</div>
      </div>
    </div>
  );
}
